echo "== {{ .chezmoi.sourceFile | trim }} =="

# Function to detect if running in Session 0 (service context)
function Test-IsSession0 {
    $sessionId = [System.Diagnostics.Process]::GetCurrentProcess().SessionId
    return ($sessionId -eq 0)
}

# Function to get active user session ID
function Get-ActiveUserSessionId {
    try {
        # Method 1: Try using quser.exe with full path
        $quserPath = "$env:SystemRoot\System32\quser.exe"
        if (Test-Path $quserPath) {
            $sessions = & $quserPath 2>&1 | Select-String "Active"
            if ($sessions) {
                $sessionLine = $sessions.Line
                # Extract session ID (typically 3rd column)
                $sessionId = ($sessionLine -split '\s+')[2]
                if ($sessionId -match '^\d+$') {
                    Write-Host "Found active session using quser: $sessionId"
                    return [int]$sessionId
                }
            }
        }
    }
    catch {
        Write-Host "Warning: quser method failed: $_"
    }
    
    try {
        # Method 2: Fallback to WMI/CIM
        $activeSessions = Get-CimInstance -ClassName Win32_LogonSession | Where-Object {
            $_.LogonType -eq 2  # Interactive logon
        }
        
        foreach ($session in $activeSessions) {
            $user = Get-CimInstance -ClassName Win32_LoggedOnUser | Where-Object {
                $_.Dependent.LogonId -eq $session.LogonId
            }
            
            if ($user) {
                # Try to get session ID from process
                $explorer = Get-Process -Name explorer -ErrorAction SilentlyContinue | Select-Object -First 1
                if ($explorer) {
                    $sessionId = $explorer.SessionId
                    if ($sessionId -gt 0) {
                        Write-Host "Found active session using WMI/Explorer: $sessionId"
                        return [int]$sessionId
                    }
                }
            }
        }
    }
    catch {
        Write-Host "Warning: WMI method failed: $_"
    }
    
    try {
        # Method 3: Simple fallback - look for explorer.exe session
        $explorer = Get-Process -Name explorer -ErrorAction SilentlyContinue | 
                    Where-Object { $_.SessionId -gt 0 } | 
                    Select-Object -First 1
        
        if ($explorer) {
            Write-Host "Found active session via explorer.exe: $($explorer.SessionId)"
            return [int]$explorer.SessionId
        }
    }
    catch {
        Write-Host "Warning: Explorer method failed: $_"
    }
    
    return $null
}

# Function to launch process in user session using PsExec
function Start-ProcessInUserSession {
    param(
        [string]$FilePath,
        [int]$SessionId
    )
    
    $psexecPath = "{{ .chezmoi.homeDir }}\.local\bin\PsExec64.exe"
    
    if (-not (Test-Path $psexecPath)) {
        Write-Host "Warning: PsExec64.exe not found at $psexecPath, falling back to direct launch"
        Start-Process -FilePath $FilePath
        return
    }
    
    try {
        # Use PsExec to launch in user session
        # -s: Run as SYSTEM (required to access other sessions)
        # -i: Interactive - run in the specified session
        # -d: Don't wait for process to terminate
        # -accepteula: Auto-accept EULA
        & $psexecPath -accepteula -s -i $SessionId -d $FilePath 2>&1 | Out-Null
        Write-Host "Launched $FilePath in session $SessionId via PsExec"
    }
    catch {
        Write-Host "Warning: Failed to launch via PsExec: $_. Trying direct launch."
        Start-Process -FilePath $FilePath
    }
}

# Main logic
$startup_dir = (New-Object -ComObject WScript.Shell).SpecialFolders.Item("Startup")
$isSession0 = Test-IsSession0

if ($isSession0) {
    Write-Host "Detected Session 0 (service context). Using PsExec to launch in user session."
    $activeSessionId = Get-ActiveUserSessionId
    
    if ($null -eq $activeSessionId) {
        Write-Host "Warning: No active user session found. AHK scripts will not be launched."
    }
    else {
        Write-Host "Active user session: $activeSessionId"
        
        # Launch AHK executables
        Get-ChildItem $startup_dir -Filter 'ahk_*.exe' -File | ForEach-Object {
            Start-ProcessInUserSession -FilePath $_.FullName -SessionId $activeSessionId
        }
        
        # Launch AHK shortcuts (extract target and launch that)
        Get-ChildItem $startup_dir -Filter 'ahk_*.lnk' -File | ForEach-Object {
            try {
                $shell = New-Object -ComObject WScript.Shell
                $shortcut = $shell.CreateShortcut($_.FullName)
                $targetPath = $shortcut.TargetPath
                if ($targetPath -and (Test-Path $targetPath)) {
                    Start-ProcessInUserSession -FilePath $targetPath -SessionId $activeSessionId
                }
            }
            catch {
                Write-Host "Warning: Could not process shortcut $($_.Name): $_"
            }
        }
    }
}
else {
    Write-Host "Not in Session 0. Launching AHK scripts directly."
    # Direct launch (original behavior)
    Get-ChildItem $startup_dir -Filter 'ahk_*.exe' -File | ForEach-Object { 
        Start-Process -FilePath $_ 
    }
    Get-ChildItem $startup_dir -Filter 'ahk_*.lnk' -File | ForEach-Object { 
        Invoke-Item $_ 
    }
}